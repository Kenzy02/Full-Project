 trigger: none

 pool:
   name: 'Default'

 variables:
   - name: TF_VERSION
     value: '1.5.0'

 stages:
   - stage: TerraformDestroy
     displayName: 'Terraform Tear Down'
     jobs:
       - job: TerraformDestroyJob
         displayName: 'Execute Destruction'
         steps:
           - checkout: self
             fetchDepth: 0

           - task: TerraformInstaller@0
             displayName: 'Setup Terraform'
             inputs:
               terraformVersion: $(TF_VERSION)

           - script: |
               echo "##[group]üßπ Prep: Cleaning cloud data"
               # Empty Velero backups (prevents BucketNotEmpty error)
               if aws s3 ls s3://kenzy-velero-backups >/dev/null 2>&1; then
                 echo "Emptying kenzy-velero-backups bucket..."
                 aws s3 rm s3://kenzy-velero-backups --recursive
               fi
               echo "##[endgroup]"
             displayName: 'Clean S3 Data'

           - script: |
               echo "##[group]üîß Initialize Terraform"
               terraform init \
                 -input=false \
                 -backend-config="bucket=kenzy-eks-bucket" \
                 -backend-config="key=terraform.tfstate" \
                 -backend-config="region=us-east-1"
               echo "##[endgroup]"
             displayName: 'Terraform Init'
             workingDirectory: '$(System.DefaultWorkingDirectory)'

           - script: |
               echo "##[group]üí£ Step 1: Destroy EKS (Compute & IAM)"
               terraform destroy -auto-approve -input=false -var-file=terraform.tfvars -target=module.eks
               echo "##[endgroup]"
             displayName: 'Destroy EKS'
             workingDirectory: '$(System.DefaultWorkingDirectory)'
             continueOnError: true # Force continue so cleanup script can run if this fails

           - script: |
               echo "##[group]üõ†Ô∏è  Step 2: Deep Infrastructure Cleanup"
               echo "Running cleanup to remove Load Balancers, Target Groups, and ENIs..."
               chmod +x ./cleanup-vpc-dependencies.sh
               ./cleanup-vpc-dependencies.sh
               echo "##[endgroup]"
             displayName: 'VPC Dependency Cleanup'
             workingDirectory: '$(System.DefaultWorkingDirectory)'
             condition: always() # CRITICAL: Always run this to unblock VPC deletion

           - script: |
               echo "##[group]üï∏Ô∏è  Step 3: Destroy VPC (Networking)"
               terraform destroy -auto-approve -input=false -var-file=terraform.tfvars -target=module.vpc
               echo "##[endgroup]"
             displayName: 'Destroy VPC'
             workingDirectory: '$(System.DefaultWorkingDirectory)'

           - script: |
               echo "##[group]üèÅ Step 4: Final Teardown (S3 & IAM Roles)"
               terraform destroy -auto-approve -input=false -var-file=terraform.tfvars
               echo "##[endgroup]"
             displayName: 'Destroy Remaining'
             workingDirectory: '$(System.DefaultWorkingDirectory)'

           - script: |
               echo "Infrastructure destruction complete. All cloud resources have been reclaimed."
             displayName: 'Execution Summary'
             condition: always()
