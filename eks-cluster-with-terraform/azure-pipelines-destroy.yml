trigger: none

pool:
  name: 'Default'

variables:
  - name: TF_VERSION
    value: '1.5.0'
  - name: TF_REGISTRY_CLIENT_TIMEOUT
    value: '30'

stages:
  - stage: TerraformDestroy
    displayName: 'Terraform Destroy'
    jobs:
      - job: TerraformDestroyJob
        displayName: 'Terraform Destroy Resources (EKS First, then VPC)'
        steps:
          - checkout: self
            fetchDepth: 0

          - task: TerraformInstaller@0
            displayName: 'Ensure Terraform $(TF_VERSION)'
            inputs:
              terraformVersion: $(TF_VERSION)

          - script: |
              echo "Initializing Terraform..."
              export TF_LOG=INFO
              terraform init \
                -input=false \
                -backend-config="bucket=kenzy-eks-bucket" \
                -backend-config="key=terraform.tfstate" \
                -backend-config="region=us-east-1"
            displayName: 'Terraform Init'
            workingDirectory: '$(System.DefaultWorkingDirectory)'

          - script: |
              echo "Step 1: Destroying EKS Cluster and Node Groups..."
              echo "This may take 10-15 minutes..."
              terraform destroy \
                -auto-approve \
                -input=false \
                -var-file=terraform.tfvars \
                -target=module.eks
            displayName: 'Destroy EKS Module'
            workingDirectory: '$(System.DefaultWorkingDirectory)'

          - script: |
              echo "Step 2A: Cleaning up orphaned AWS resources..."
              
              # Get VPC ID
              VPC_ID=$(terraform output -raw vpc_id 2>/dev/null || aws ec2 describe-vpcs --filters "Name=tag:Name,Values=kenzy-eks-vpc" --query "Vpcs[0].VpcId" --output text)
              echo "VPC ID: $VPC_ID"
              
              if [ "$VPC_ID" != "None" ] && [ ! -z "$VPC_ID" ]; then
                # Delete Load Balancers
                echo "Finding and deleting Load Balancers..."
                LB_ARNS=$(aws elbv2 describe-load-balancers --query "LoadBalancers[?VpcId=='$VPC_ID'].LoadBalancerArn" --output text)
                for LB_ARN in $LB_ARNS; do
                  echo "Deleting Load Balancer: $LB_ARN"
                  aws elbv2 delete-load-balancer --load-balancer-arn $LB_ARN || true
                done
                
                # Delete Classic Load Balancers
                echo "Finding and deleting Classic Load Balancers..."
                CLB_NAMES=$(aws elb describe-load-balancers --query "LoadBalancerDescriptions[?VPCId=='$VPC_ID'].LoadBalancerName" --output text)
                for CLB_NAME in $CLB_NAMES; do
                  echo "Deleting Classic Load Balancer: $CLB_NAME"
                  aws elb delete-load-balancer --load-balancer-name $CLB_NAME || true
                done
                
                # Wait for load balancers to be deleted
                echo "Waiting 60 seconds for load balancers to be deleted..."
                sleep 60
                
                # Delete Network Interfaces
                echo "Finding and deleting Network Interfaces..."
                SUBNET_IDS=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=$VPC_ID" --query "Subnets[].SubnetId" --output text)
                for SUBNET_ID in $SUBNET_IDS; do
                  ENI_IDS=$(aws ec2 describe-network-interfaces --filters "Name=subnet-id,Values=$SUBNET_ID" --query "NetworkInterfaces[].NetworkInterfaceId" --output text)
                  for ENI_ID in $ENI_IDS; do
                    echo "Detaching and deleting ENI: $ENI_ID"
                    # Try to detach if attached
                    ATTACHMENT_ID=$(aws ec2 describe-network-interfaces --network-interface-ids $ENI_ID --query "NetworkInterfaces[0].Attachment.AttachmentId" --output text)
                    if [ "$ATTACHMENT_ID" != "None" ] && [ ! -z "$ATTACHMENT_ID" ]; then
                      aws ec2 detach-network-interface --attachment-id $ATTACHMENT_ID --force || true
                      sleep 5
                    fi
                    # Delete the ENI
                    aws ec2 delete-network-interface --network-interface-id $ENI_ID || true
                  done
                done
                
                # Delete NAT Gateways
                echo "Finding and deleting NAT Gateways..."
                NAT_IDS=$(aws ec2 describe-nat-gateways --filter "Name=vpc-id,Values=$VPC_ID" "Name=state,Values=available" --query "NatGateways[].NatGatewayId" --output text)
                for NAT_ID in $NAT_IDS; do
                  echo "Deleting NAT Gateway: $NAT_ID"
                  aws ec2 delete-nat-gateway --nat-gateway-id $NAT_ID || true
                done
                
                if [ ! -z "$NAT_IDS" ]; then
                  echo "Waiting 120 seconds for NAT Gateways to be deleted..."
                  sleep 120
                fi
                
                echo "Cleanup complete!"
              else
                echo "VPC not found, skipping cleanup"
              fi
            displayName: 'Cleanup Orphaned Resources'
            workingDirectory: '$(System.DefaultWorkingDirectory)'

          - script: |
              echo "Step 2B: Destroying VPC and Subnets..."
              echo "This may take 5-10 minutes..."
              terraform destroy \
                -auto-approve \
                -input=false \
                -var-file=terraform.tfvars \
                -target=module.vpc
            displayName: 'Destroy VPC Module'
            workingDirectory: '$(System.DefaultWorkingDirectory)'

          - script: |
              echo "Step 3: Destroying remaining resources..."
              terraform destroy \
                -auto-approve \
                -input=false \
                -var-file=terraform.tfvars
            displayName: 'Destroy Remaining Resources'
            workingDirectory: '$(System.DefaultWorkingDirectory)'

          - script: |
              echo "=========================================="
              echo "Terraform Destroy Complete!"
              echo "=========================================="
              echo "All resources have been destroyed."
              echo "Check AWS console to verify all resources are deleted."
            displayName: 'Destroy Summary'
