trigger: none

pool:
  name: 'Default'

variables:
  - name: TF_VERSION
    value: '1.5.0'
  # Increases the timeout for downloading providers/registry calls (in minutes)
  - name: TF_REGISTRY_CLIENT_TIMEOUT
    value: '30'

stages:
  - stage: Terraform
    displayName: 'Terraform Deployment'
    jobs:
      - job: TerraformRun
        displayName: 'Terraform Init & Apply'
        steps:
          - checkout: self
            fetchDepth: 0

          - task: TerraformInstaller@0
            displayName: 'Ensure Terraform $(TF_VERSION)'
            inputs:
              terraformVersion: $(TF_VERSION)

          - script: |
              echo "##[group]üîß Initialize Terraform"
              terraform init \
                -input=false \
                -backend-config="bucket=kenzy-eks-bucket" \
                -backend-config="key=terraform.tfstate" \
                -backend-config="region=us-east-1"
               echo "##[endgroup]"
            displayName: 'Terraform Init'
            workingDirectory: '$(System.DefaultWorkingDirectory)'

          - script: |
              echo "##[group]üõ°Ô∏è Setup Security Tools"
              # Install Ansible if missing
              if ! command -v ansible-playbook &> /dev/null; then
                sudo apt update && sudo apt install -y ansible
              fi
              
              # Run Ansible to install Checkov, tfsec, TFLint
              cd ansible
              ansible-playbook playbook.yml --tags "checkov,tfsec,tflint"
              echo "##[endgroup]"
            displayName: 'Install Security Tools (Ansible)'
            workingDirectory: '$(System.DefaultWorkingDirectory)'

          - script: |
              echo "##[group]üîç Running Pre-Apply Security Scans"
              echo "--- tfsec scan ---"
              tfsec .
              
              echo "--- checkov scan ---"
              checkov -d . --quiet --compact
              
              echo "--- tflint scan ---"
              tflint --init && tflint
              echo "##[endgroup]"
            displayName: 'Execute Security Audits'
            workingDirectory: '$(System.DefaultWorkingDirectory)'
            continueOnError: true # Report results but don't block yet (user choice)

          - script: |
              echo "##[group]üìã Terraform Plan"
              terraform plan -input=false -var-file=terraform.tfvars -out=tfplan
              echo "##[endgroup]"
            displayName: 'Terraform Plan'
            workingDirectory: '$(System.DefaultWorkingDirectory)'

          - script: |
              echo "##[group]üöÄ Terraform Apply"
              terraform apply -auto-approve tfplan
              echo "##[endgroup]"
            displayName: 'Terraform Apply'
            workingDirectory: '$(System.DefaultWorkingDirectory)'

          - script: |
              echo "##[group]‚ò∏Ô∏è Configure Cluster Platform (ArgoCD & Kyverno)"
              # Use Ansible to deploy the cluster platform resources
              cd ansible
              ansible-playbook playbook.yml --tags "cloudtrail,kyverno,argocd"
              echo "##[endgroup]"
            displayName: 'Finalize Platform Setup'
            workingDirectory: '$(System.DefaultWorkingDirectory)'
            condition: succeeded()