trigger: none

pool:
  name: 'Default'

variables:
  - name: TF_VERSION
    value: '1.5.0'
  # Increases the timeout for downloading providers/registry calls (in minutes)
  - name: TF_REGISTRY_CLIENT_TIMEOUT
    value: '30'

stages:
  - stage: Terraform
    displayName: 'Terraform Deployment'
    jobs:
      - job: TerraformRun
        displayName: 'Terraform Init & Apply'
        steps:
          - checkout: self
            fetchDepth: 0

          - task: TerraformInstaller@0
            displayName: 'Ensure Terraform $(TF_VERSION)'
            inputs:
              terraformVersion: $(TF_VERSION)

          - script: |
              echo "##[group]üîß Initialize Terraform"
              terraform init \
                -input=false \
                -backend-config="bucket=kenzy-eks-bucket" \
                -backend-config="key=terraform.tfstate" \
                -backend-config="region=us-east-1"
               echo "##[endgroup]"
            displayName: 'Terraform Init'
            workingDirectory: '$(System.DefaultWorkingDirectory)'

          - script: |
              echo "##[group]üîç Generating HTML Security Reports"
              mkdir -p $(System.DefaultWorkingDirectory)/security-reports
              
              # Install jinja2 for potential custom HTML templates if needed later
              pip install jinja2 pyyaml --user
              
              echo "--- Running tfsec (JSON for records) ---"
              tfsec . --format json --out $(System.DefaultWorkingDirectory)/security-reports/tfsec-report.json || true
              
              echo "--- Running checkov (HTML) ---"
              # Checkov supports multiple outputs. We generate HTML for the dashboard.
              checkov -d . --output html > $(System.DefaultWorkingDirectory)/security-reports/checkov-report.html || true
              
              echo "--- Running tflint (JSON) ---"
              tflint --init && tflint --format json > $(System.DefaultWorkingDirectory)/security-reports/tflint-report.json || true

              echo "--- Running trivy (HTML) ---"
              # Install Trivy if missing
              if ! command -v trivy &> /dev/null; then
                wget -qO - https://aquasecurity.github.io/trivy-repo/dabest.gpg | sudo apt-key add -
                echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
                sudo apt update && sudo apt install -y trivy
              fi
              # Download an HTML template for Trivy or use built-in
              trivy config . --format template --template "@contrib/html.tpl" --output $(System.DefaultWorkingDirectory)/security-reports/trivy-report.html || true
              
              # Create a simple Index.html for the dashboard if it doesn't exist
              echo "<h1>Security Audit Summary</h1><ul><li><a href='trivy-report.html'>Trivy Report</a></li><li><a href='checkov-report.html'>Checkov Report</a></li></ul>" > $(System.DefaultWorkingDirectory)/security-reports/index.html
              echo "##[endgroup]"
            displayName: 'Execute Security Audits & Generate HTML'
            workingDirectory: '$(System.DefaultWorkingDirectory)'

          # This task enables the "HTML Report" tab in the Azure DevOps build results
          - task: PublishHtmlReport@1
            displayName: 'Publish Security Dashboard'
            inputs:
              reportDir: '$(System.DefaultWorkingDirectory)/security-reports/index.html'
              tabName: 'Security Analysis'

          - task: PublishPipelineArtifact@1
            displayName: 'Archive Raw Security Data'
            inputs:
               targetPath: '$(System.DefaultWorkingDirectory)/security-reports'
               artifact: 'SecurityReports'
               publishLocation: 'pipeline'

          - script: |
              echo "##[group]üìã Terraform Plan"
              terraform plan -input=false -var-file=terraform.tfvars -out=tfplan
              echo "##[endgroup]"
            displayName: 'Terraform Plan'
            workingDirectory: '$(System.DefaultWorkingDirectory)'

          - script: |
              echo "##[group]üöÄ Terraform Apply"
              terraform apply -auto-approve tfplan
              echo "##[endgroup]"
            displayName: 'Terraform Apply'
            workingDirectory: '$(System.DefaultWorkingDirectory)'

          - script: |
              echo "##[group]‚ò∏Ô∏è Configure Cluster Platform (ArgoCD & Kyverno)"
              # Use Ansible to deploy the cluster platform resources
              cd ansible
              ansible-playbook playbook.yml --tags "cloudtrail,kyverno,argocd"
              echo "##[endgroup]"
            displayName: 'Finalize Platform Setup'
            workingDirectory: '$(System.DefaultWorkingDirectory)'
            condition: succeeded()